<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ELDROW</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="game-container" style="position: relative;">
    <h1><i class="fas fa-gamepad"></i> ELDROW</h1>

    <div class="home-stats" id="home-stats">
      <div>High Score: <span id="high-score">0</span></div>
    </div>

    <div class="game-stats" id="game-stats" style="display: none;">
      <div class="stats-row">
        <div class="timer" id="timer"><i class="fas fa-stopwatch"></i><span id="timer-value">60</span></div>
        <div id="hearts-display"></div>
        <div><i class="fas fa-star"></i> <span id="score">0</span></div>
      </div>
      <div class="level-row">
        <div class="level-display" id="level-display">level <span id="level-number">1</span></div>
      </div>
    </div>

    <div id="game-area">
      <div id="start-screen">
        <p>Listen to the reversed word and guess the original!</p>
        <div class="start-section">
          <button class="start-button" onclick="startGame()">Start Game</button>
          <div class="language-selector">
            <button class="current-lang-btn" id="current-lang" onclick="toggleLanguagePopup()">EN</button>
            <div class="language-popup" id="language-popup">
              <button class="lang-option active" data-lang="english" onclick="selectLanguageFromPopup('english')">EN</button>
              <button class="lang-option" data-lang="russian" onclick="selectLanguageFromPopup('russian')">RU</button>
              <button class="lang-option" data-lang="german" onclick="selectLanguageFromPopup('german')">DE</button>
              <button class="lang-option" data-lang="spanish" onclick="selectLanguageFromPopup('spanish')">ES</button>
            </div>
          </div>
        </div>
      </div>

      <div id="play-screen" style="display: none;">
        <div style="margin-bottom: 20px; max-width: 500px; margin-left: auto; margin-right: auto; position: relative;">
          <div class="word-display" id="word-display" onclick="refocusInput()"></div>
          <input type="text" class="hidden-input" id="hidden-input" autocomplete="off" spellcheck="false"
                 onkeypress="handleKeyPress(event)" oninput="handleInput(event)"
                 onblur="refocusInput()">
        </div>

        <div style="display: flex; gap: 15px; margin-bottom: 20px; max-width: 500px; margin-left: auto; margin-right: auto; align-items: stretch; position: relative;">
          <button class="skip-button" onclick="skipWord(); refocusInput()" style="flex: 1;" id="skip-btn">Skip Word</button>
          <button class="play-button speaker-btn" id="play-btn" onclick="playReversedWord(); refocusInput()"><i class="fas fa-volume-up"></i></button>
          <button class="submit-button" onclick="submitGuess(); refocusInput()" style="flex: 1;" id="submit-btn">Submit</button>
          <div id="points-animation-container" style="position: absolute; pointer-events: none; width: 100%; height: 100%;"></div>
        </div>

        <div class="feedback" id="feedback"></div>
      </div>

      <div id="game-over-screen" style="display: none;" class="game-over">
        <h2>Score</h2>
        <p>Last: <i class="fas fa-star"></i> <span id="final-score">0</span></p>
        <p>Best: <i class="fas fa-star"></i> <span id="best-score">0</span></p>

        <div class="share-buttons" style="margin: 20px 0; display: flex; gap: 10px; justify-content: center;">
          <button class="share-btn twitter" onclick="shareToTwitter()"><i class="fab fa-twitter"></i></button>
          <button class="share-btn facebook" onclick="shareToFacebook()"><i class="fab fa-facebook"></i></button>
          <button class="share-btn whatsapp" onclick="shareToWhatsApp()"><i class="fab fa-whatsapp"></i></button>
          <button class="share-btn telegram" onclick="shareToTelegram()"><i class="fab fa-telegram"></i></button>
          <button class="share-btn copy" onclick="copyScore()" title="Copy score"><i class="fas fa-copy"></i></button>
        </div>

        <button class="start-button" onclick="restartGame()">Play Again</button>
      </div>
    </div>
  </div>

  <script>
    let words = [];

    let gameState = {
      score: 0,
      lives: 3,
      level: 1,
      currentWord: "",
      timeLeft: 60,
      timer: null,
      wordsGuessed: 0,
      isPlaying: false,
      currentLanguage: 'english',
      speechLang: 'en-US',
      highScore: 0,
      currentGuess: "",
      displayState: "normal" // normal, correct, skipped, timeout
    };

    async function loadWords(language) {
      try {
        console.log(`Loading words for language: ${language}`);
        const response = await fetch(`words_${language}.txt`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const text = await response.text();
        words = text.trim().split('\n').filter(word => word.trim().length > 0);
        console.log(`Successfully loaded ${language} words. Total words count:`, words.length);
        console.log(`First 5 words:`, words.slice(0, 5));
        console.log(`Word lengths range: ${Math.min(...words.map(w => w.length))} - ${Math.max(...words.map(w => w.length))}`);
      } catch (error) {
        console.error(`Failed to load ${language} words:`, error);
        // Fallback to basic English words
        words = ["cat", "dog", "run", "sun", "car", "big", "red", "hot", "fun", "hat", "happy", "jumping", "morning", "kitchen", "rainbow", "picture", "adventure", "beautiful", "dangerous", "knowledge", "mysterious"];
        console.log("Using fallback English words");
      }
    }

    function saveSettings() {
      const settings = {
        language: gameState.currentLanguage,
        highScore: gameState.highScore
      };
      localStorage.setItem('eldrow-settings', JSON.stringify(settings));
    }

    function loadSettings() {
      try {
        const saved = localStorage.getItem('eldrow-settings');
        if (saved) {
          const settings = JSON.parse(saved);
          gameState.currentLanguage = settings.language || 'english';
          gameState.highScore = settings.highScore || 0;

          // Update UI
          updateLanguageDisplay();
          updateDisplay();
        }
      } catch (error) {
        console.error('Failed to load settings:', error);
      }
    }

    function updateLanguageDisplay() {
      const langCodes = {
        english: 'EN',
        russian: 'RU',
        german: 'DE',
        spanish: 'ES'
      };

      // Update current language button
      document.getElementById('current-lang').textContent = langCodes[gameState.currentLanguage];

      // Update popup options
      const options = document.querySelectorAll('.lang-option');
      options.forEach(option => {
        if (option.dataset.lang === gameState.currentLanguage) {
          option.classList.add('active');
        } else {
          option.classList.remove('active');
        }
      });
    }

    function toggleLanguagePopup() {
      const popup = document.getElementById('language-popup');
      popup.classList.toggle('show');
    }

    async function selectLanguageFromPopup(language) {
      const wasPlaying = gameState.isPlaying;

      gameState.currentLanguage = language;
      await loadWords(gameState.currentLanguage);

      // Set speech language based on selection
      const langCodes = {
        english: 'en-US',
        russian: 'ru-RU',
        german: 'de-DE',
        spanish: 'es-ES'
      };
      gameState.speechLang = langCodes[gameState.currentLanguage];

      updateLanguageDisplay();
      saveSettings();

      // Hide popup
      document.getElementById('language-popup').classList.remove('show');

      // If game was playing, start a new word with the new language
      if (wasPlaying) {
        nextWord();
      }
    }

    async function selectLanguage(language) {
      // Keep for backward compatibility
      await selectLanguageFromPopup(language);
    }

    function resetInput() {
      const hiddenInput = document.getElementById('hidden-input');
      gameState.currentGuess = '';
      if (hiddenInput) {
        hiddenInput.value = '';
      }
    }

    function initializeWordDisplay() {
      const wordDisplay = document.getElementById('word-display');

      resetInput();
      gameState.displayState = 'normal';
      updateWordDisplay();
    }

    function updateWordDisplay() {
      const wordDisplay = document.getElementById('word-display');
      const wordLength = gameState.currentWord.length;
      const guessLength = gameState.currentGuess.length;

      let displayText = '';

      // Show typed letters and remaining asterisks
      for (let i = 0; i < wordLength; i++) {
        if (i < guessLength) {
          displayText += `<span class="letter typed">${gameState.currentGuess[i]}</span>`;
        } else {
          displayText += `<span class="letter asterisk">*</span>`;
        }
      }

      wordDisplay.innerHTML = displayText;

      // Apply state-based styling
      wordDisplay.className = `word-display ${gameState.displayState}`;
    }

    function handleInput(event) {
      if (!gameState.isPlaying) return;

      const input = event.target.value;
      const wordLength = gameState.currentWord.length;

      // Only allow Unicode letters and limit to word length
      const filteredInput = input.replace(/[^\p{L}]/gu, '').toLowerCase().slice(0, wordLength);

      // Update the input field with filtered value to keep it in sync
      if (event.target.value !== filteredInput) {
        event.target.value = filteredInput;
      }

      gameState.currentGuess = filteredInput;
      updateWordDisplay();
    }


    async function changeLanguage() {
      // Keep this function for backward compatibility
      await selectLanguageFromPopup(gameState.currentLanguage);
    }

    function showPointsAnimation(buttonId, points) {
      const button = document.getElementById(buttonId);
      const container = document.getElementById('points-animation-container');

      if (!button || !container) return;

      // Get button position relative to container
      const buttonRect = button.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();

      const relativeX = buttonRect.left - containerRect.left + buttonRect.width / 2;
      const relativeY = buttonRect.top - containerRect.top + buttonRect.height * 0.25;

      // Create popup element
      const popup = document.createElement('div');
      popup.className = `points-popup ${points > 0 ? 'positive' : 'negative'}`;
      popup.textContent = points > 0 ? `+${points}` : `${points}`;
      popup.style.left = relativeX + 'px';
      popup.style.top = relativeY + 'px';
      popup.style.transform = 'translate(-50%, -50%)';

      container.appendChild(popup);

      // Remove element after animation
      setTimeout(() => {
        if (popup.parentNode) {
          popup.parentNode.removeChild(popup);
        }
      }, 2000);
    }

    async function startGame() {
      await loadWords(gameState.currentLanguage);

      // Set speech language before resetting gameState
      const langCodes = {
        english: 'en-US',
        russian: 'ru-RU',
        german: 'de-DE',
        spanish: 'es-ES'
      };
      const speechLang = langCodes[gameState.currentLanguage];

      gameState = {
        ...gameState,
        score: 0,
        lives: 3,
        level: 1,
        currentWord: "",
        timeLeft: 60,
        timer: null,
        wordsGuessed: 0,
        isPlaying: true,
        speechLang: speechLang // Preserve speech language
      };

      // Re-enable submit button when starting new game
      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn) {
        submitBtn.disabled = false;
      }

      // Show game elements, hide home elements
      document.getElementById("home-stats").style.display = "none";
      document.getElementById("game-stats").style.display = "flex";

      updateDisplay();
      document.getElementById("start-screen").style.display = "none";
      document.getElementById("play-screen").style.display = "block";
      document.getElementById("game-over-screen").style.display = "none";

      // Ensure input is clean before starting
      resetInput();

      nextWord();
    }

    function nextWord() {
      if (!gameState.isPlaying) return;

      if (!words || words.length === 0) {
        console.error(`No words available`);
        return;
      }

      // Filter words by length based on level: (level + 2) <= len <= (level + 2) * 2
      const minLength = gameState.level + 2;
      const maxLength = (gameState.level + 2) * 2;
      const filteredWords = words.filter(word => word.length >= minLength && word.length <= maxLength);

      // If no words match the criteria, fallback to original list
      const availableWords = filteredWords.length > 0 ? filteredWords : words;

      gameState.currentWord = availableWords[Math.floor(Math.random() * availableWords.length)];
      console.log(`Selected word: ${gameState.currentWord} (${gameState.currentLanguage}, level ${gameState.level}, length ${gameState.currentWord.length}, range: ${minLength}-${maxLength}, available: ${availableWords.length})`);

      // Timer is already set by the calling function (correct answer, timeout, or fresh start)

      updateDisplay();
      startTimer();

      initializeWordDisplay();
      document.getElementById("feedback").textContent = "";
      refocusInput();

      setTimeout(() => {
        if (gameState.isPlaying) {
          playReversedWord();
        }
      }, 500);
    }

    function playReversedWord() {
      if (!gameState.isPlaying) return;

      const reversedWord = gameState.currentWord.split("").reverse().join("");
      const utterance = new SpeechSynthesisUtterance(reversedWord);
      utterance.rate = Math.max(0.3, 1 - gameState.level * 0.05);
      utterance.pitch = 1;
      utterance.volume = 1;
      utterance.lang = gameState.speechLang || 'en-US';

      speechSynthesis.cancel();
      speechSynthesis.speak(utterance);
    }

    function submitGuess() {
      if (!gameState.isPlaying) return;

      const guess = gameState.currentGuess.toLowerCase().trim();
      const feedback = document.getElementById("feedback");

      if (guess === gameState.currentWord.toLowerCase()) {
        const wordLength = gameState.currentWord.length;
        // Бонус за быстрое угадывание: 3x если больше 30 сек, иначе 2x
        const multiplier = gameState.timeLeft > 30 ? 3 : 2;
        const points = multiplier * wordLength;
        gameState.score += points;
        gameState.wordsGuessed++;

        // Повышаем уровень каждые 5 угаданных слов
        gameState.level = Math.floor(gameState.wordsGuessed / 5) + 1;

        // Show points animation from Submit button
        showPointsAnimation('submit-btn', points);

        // Highlight word display green for correct answer
        gameState.displayState = 'correct';
        updateWordDisplay();

        clearInterval(gameState.timer);
        // Reset timer to 60 for next word
        gameState.timeLeft = 60;

        setTimeout(() => {
          nextWord();
        }, 2000);

      } else {
        // Flash submit button and change text
        const submitBtn = document.querySelector('.submit-button');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = 'Wrong';
        submitBtn.classList.add('wrong');

        setTimeout(() => {
          submitBtn.innerHTML = originalText;
          submitBtn.classList.remove('wrong');
        }, 800);

        // Don't reduce lives for wrong guesses
      }

      updateDisplay();
    }

    function skipWord() {
      // Show the correct word in grey
      gameState.currentGuess = gameState.currentWord;
      gameState.displayState = 'skipped';
      updateWordDisplay();

      // Reduce score by 1x количество букв, but don't go below 0
      const wordLength = gameState.currentWord.length;
      const points = -wordLength;
      const oldScore = gameState.score;
      gameState.score = Math.max(0, gameState.score - wordLength);

      // Show points animation from Skip button (only if score actually decreased)
      if (oldScore > gameState.score) {
        showPointsAnimation('skip-btn', points);
      }

      clearInterval(gameState.timer);

      // If less than 10 seconds, boost to 10 seconds
      if (gameState.timeLeft < 10) {
        gameState.timeLeft = 10;
      }

      setTimeout(() => {
        nextWord();
      }, 2000);

      updateDisplay();
    }

    function startTimer() {
      clearInterval(gameState.timer);
      gameState.timer = setInterval(() => {
        gameState.timeLeft--;
        updateDisplay();

        if (gameState.timeLeft <= 0) {
          gameState.lives--; // Reduce life for timeout
          clearInterval(gameState.timer);

          // Show correct answer in red
          gameState.currentGuess = gameState.currentWord;
          gameState.displayState = 'timeout';
          updateWordDisplay();

          // Reset timer to 60 for next word
          gameState.timeLeft = 60;
          updateDisplay();

          if (gameState.lives <= 0) {
            setTimeout(() => {
              endGame();
            }, 2000);
          } else {
            setTimeout(() => {
              nextWord();
            }, 2000);
          }
        }
      }, 1000);
    }

    function endGame() {
      gameState.isPlaying = false;
      clearInterval(gameState.timer);
      speechSynthesis.cancel();

      // Disable submit button when game is over
      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn) {
        submitBtn.disabled = true;
      }

      // Update high score if current score is higher
      if (gameState.score > gameState.highScore) {
        gameState.highScore = gameState.score;
        saveSettings();
      }

      document.getElementById("final-score").textContent = gameState.score;
      document.getElementById("best-score").textContent = gameState.highScore;

      updateDisplay();
      // Don't hide play screen, just show game over overlay
      document.getElementById("game-over-screen").style.display = "block";
    }

    function goHome() {
      // Stop current game
      gameState.isPlaying = false;
      clearInterval(gameState.timer);
      speechSynthesis.cancel();

      // Hide game elements, show home elements
      document.getElementById("home-stats").style.display = "flex";
      document.getElementById("game-stats").style.display = "none";

      document.getElementById("start-screen").style.display = "block";
      document.getElementById("play-screen").style.display = "none";
      document.getElementById("game-over-screen").style.display = "none";
    }

    function restartGame() {
      // Hide game over overlay first
      document.getElementById("game-over-screen").style.display = "none";
      startGame();
    }

    function updateDisplay() {
      document.getElementById("score").textContent = gameState.score;
      document.getElementById("high-score").textContent = gameState.highScore;
      updateHeartsDisplay();
      updateLevelDisplay();

      // Update timer with color coding
      const timerElement = document.getElementById("timer");
      const timerValue = document.getElementById("timer-value");
      const timeLeft = Math.max(0, gameState.timeLeft); // Never show negative

      timerValue.textContent = timeLeft;

      // Reset timer classes
      timerElement.className = "timer";

      // Add danger class when 10 seconds or less
      if (timeLeft <= 10 && timeLeft > 0) {
        timerElement.classList.add("danger");
      }
    }

    function updateLevelDisplay() {
      const levelNumber = document.getElementById("level-number");

      if (!levelNumber) return;

      levelNumber.textContent = gameState.level;
    }

    function updateHeartsDisplay() {
      const heartsContainer = document.getElementById("hearts-display");
      heartsContainer.innerHTML = "";

      const totalHearts = 3; // Always show 3 heart positions

      for (let i = 0; i < totalHearts; i++) {
        const heart = document.createElement("i");
        if (i < gameState.lives) {
          // Alive heart
          heart.className = "fas fa-heart";
          heart.style.color = "#e74c3c";
        } else {
          // Broken heart
          heart.className = "fas fa-heart-broken";
          heart.style.color = "#bdc3c7"; // Gray color for broken hearts
        }
        heart.style.marginRight = "3px";
        heartsContainer.appendChild(heart);
      }
    }

    function handleKeyPress(event) {
      if (event.key === "Enter") {
        submitGuess();
        refocusInput();
      }
    }

    function refocusInput() {
      setTimeout(() => {
        const hiddenInput = document.getElementById("hidden-input");
        if (hiddenInput && gameState.isPlaying) {
          hiddenInput.focus();
        }
      }, 50);
    }

    function shareToTwitter() {
      const text = `Just scored ${gameState.score} stars in ELDROW! My best: ${gameState.highScore} ⭐\n\nPlay this reverse word game: `;
      const url = window.location.href;
      const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
      window.open(twitterUrl, '_blank');
    }

    function shareToFacebook() {
      const url = window.location.href;
      const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
      window.open(facebookUrl, '_blank');
    }

    function copyScore() {
      const text = `ELDROW Score: ${gameState.score} stars ⭐\nBest: ${gameState.highScore} stars\n\nPlay: ${window.location.href}`;

      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
          showCopyFeedback();
        });
      } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showCopyFeedback();
      }
    }

    function showCopyFeedback() {
      const copyBtn = document.querySelector('.share-btn.copy');
      const originalIcon = copyBtn.innerHTML;
      copyBtn.innerHTML = '<i class="fas fa-check"></i>';
      copyBtn.style.backgroundColor = '#28a745';

      setTimeout(() => {
        copyBtn.innerHTML = originalIcon;
        copyBtn.style.backgroundColor = '#6c757d';
      }, 2000);
    }

    function shareToWhatsApp() {
      const text = `ELDROW Score: ${gameState.score} stars ⭐\nBest: ${gameState.highScore} stars\n\nPlay this reverse word game: ${window.location.href}`;
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
      window.open(whatsappUrl, '_blank');
    }

    function shareToTelegram() {
      const text = `ELDROW Score: ${gameState.score} stars ⭐\nBest: ${gameState.highScore} stars\n\nPlay this reverse word game: ${window.location.href}`;
      const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(text)}`;
      window.open(telegramUrl, '_blank');
    }

    // Close popup when clicking outside
    document.addEventListener('click', (event) => {
      const popup = document.getElementById('language-popup');
      const langSelector = document.querySelector('.language-selector');

      if (popup && !langSelector.contains(event.target)) {
        popup.classList.remove('show');
      }
    });

    // Initialize the game
    window.addEventListener('DOMContentLoaded', () => {
      loadSettings(); // Load saved settings first
      changeLanguage(); // Load language (will use saved language)
    });

    window.addEventListener('beforeunload', () => {
      speechSynthesis.cancel();
      clearInterval(gameState.timer);
    });
  </script>
</body>
</html>